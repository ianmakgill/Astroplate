---
import ImageMod from "@/components/ImageMod.astro";
import Pagination from "@/components/Pagination.astro";
import config from "@/config/config.json";
import Base from "@/layouts/Base.astro";
import { getListPage, getSinglePage } from "@/lib/contentParser.astro";
import { sortByDate } from "@/lib/utils/sortFunctions";
import { plainify } from "@/lib/utils/textConverter";
import PageHeader from "@/partials/PageHeader.astro";
import FeaturePanelWithChart from "@/layouts/shortcodes/FeaturePanelWithChart.astro";
import D3Chart from "@/layouts/shortcodes/D3Chart.astro";

// Map research items to their corresponding charts
const chartMapping: Record<string, { chartId: string; scriptSrc: string }> = {
  "global-medical-healthcare-supply-chain-analysis-2025": {
    chartId: "health-market-value-trends",
    scriptSrc: "/scripts/health-market-value-trends-chart.js",
  },
  "defence-and-security-procurement-trends-global-analysis-2025": {
    chartId: "defence-market-value-volume-annualy-2022-2024",
    scriptSrc: "/scripts/defence-market-value-trends-chart.js",
  },
  "digital-tech-procurement-trends-global-analysis-2025": {
    chartId: "heatmap-software-categories",
    scriptSrc: "/scripts/software-demand-heatmap-chart.js",
  },
};

const COLLECTION_FOLDER = "research";
const { summary_length }: { summary_length: number } = config.settings;

const collectionIndex = await getListPage(COLLECTION_FOLDER, "-index");
if (collectionIndex.data.draft) {
  return Astro.redirect("/404");
}
const items = await getSinglePage(COLLECTION_FOLDER);
const sortedItems = sortByDate(items);
const totalPages: number = Math.ceil(items.length / config.settings.pagination);
const currentItems = sortedItems.slice(0, config.settings.pagination);
---

<Base
  title={collectionIndex.data.title}
  meta_title={collectionIndex.data.meta_title}
  image={collectionIndex.data.image}
  description={collectionIndex.data.description}
>
  <PageHeader title={collectionIndex?.data.title} />
  {
    currentItems.map((item, index) => {
      const { title, image, description } = item.data;
      const imageSide = index % 2 === 0 ? "right" : "left";
      const chart = chartMapping[item.id];

      return (
        <section class="section">
          <div class="container">
            <div class="row items-center justify-between">
              {chart && (
                <div
                  class:list={[
                    "mb-6 md:col-6 lg:col-5 md:mb-0",
                    { "md:order-2": imageSide === "right" },
                  ]}
                >
                  <D3Chart
                    id={chart.chartId}
                    height={480}
                  />
                  <script is:inline src={chart.scriptSrc}></script>
                </div>
              )}
              <div
                class:list={[
                  chart ? "md:col-6 lg:col-5" : "md:col-12",
                  { "md:order-1": imageSide === "right" },
                ]}
              >
                <h2 class="mb-4">
                  <a href={`/${COLLECTION_FOLDER}/${item.id}`}>{title}</a>
                </h2>
                {description && (
                  <p class="mb-6 text-lg">{description}</p>
                )}
                <a
                  class="btn btn-outline-primary"
                  href={`/${COLLECTION_FOLDER}/${item.id}`}
                >
                  Read more
                </a>
              </div>
            </div>
          </div>
        </section>
      );
    })
  }
  <section class="section pt-0">
    <div class="container">
      <Pagination
        section={COLLECTION_FOLDER}
        currentPage={1}
        totalPages={totalPages}
      />
    </div>
  </section>
</Base>
