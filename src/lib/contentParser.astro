---
import {
  getCollection,
  type CollectionEntry,
  type CollectionKey,
  type ContentEntryMap,
} from "astro:content";

import config from "@/config/config.json";

export const getSinglePage = async <C extends CollectionKey>(
  collectionName: C,
  lang: keyof ContentEntryMap
): Promise<CollectionEntry<C>[]> => {
  const { default_language } = config.settings;
  const langCollection: keyof ContentEntryMap = lang as keyof ContentEntryMap;

  const languages = [
    {
      languageName: "En",
      languageCode: "en",
      contentDir: "english",
      weight: 1,
    },
    {
      languageName: "Fr",
      languageCode: "fr",
      contentDir: "french",
      weight: 2,
    },
  ];

  const language = languages.find(
    (l) =>
      l.languageCode === langCollection || l.languageCode === default_language
  );

  if (!language) {
    throw new Error("Language not found");
  }

  const { contentDir } = language;

  // Explicitly define the type of pages to CollectionEntry<C>[]
  const pages: CollectionEntry<C>[] = (await getCollection(
    contentDir as any,
    ({ id }: any) => {
      return id.startsWith(collectionName) && !id.endsWith("-index.md");
    }
  )) as CollectionEntry<C>[];

  //@ts-ignore
  const removeDrafts = pages.filter((data) => !data.data.draft);
  return removeDrafts;
};

export const getListPage = async <C extends CollectionKey>(
  collectionName: C,
  lang: keyof ContentEntryMap
): Promise<CollectionEntry<C>[]> => {
  const { default_language } = config.settings;

  const languages = [
    {
      languageName: "En",
      languageCode: "en",
      contentDir: "english",
      weight: 1,
    },
    {
      languageName: "Fr",
      languageCode: "fr",
      contentDir: "french",
      weight: 2,
    },
  ];

  const language = languages.find(
    (l) => l.languageCode == lang || l.languageCode == default_language
  );

  if (!language) {
    throw new Error("Language not found");
  }

  const { contentDir } = language;

  // Fetch the collection based on the language
  const pages: CollectionEntry<C>[] = (await getCollection(
    contentDir as any,
    ({ id }: any) => {
      return id.startsWith(collectionName);
    }
  )) as CollectionEntry<C>[];

  return pages;
};
---
